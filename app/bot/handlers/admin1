from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.filters import StateFilter
from aiogram.fsm.context import FSMContext

from app.core.config import settings
from app.services.logic import t
from app.bot.states.admin import AdminStates
from app.bot.keyboards.admin import get_admin_menu_kb
from app.core.db import SessionLocal
from app.models.users import User
from app.models.investments import Investment

router = Router()


@router.message(F.text == "/admin")
async def cmd_admin(msg: Message, state: FSMContext):
    if msg.from_user.id not in settings.ADMIN_TG_IDS:
        await msg.answer(t("not_admin", msg.from_user.language_code))
        return

    await msg.answer(
        t("admin_panel", msg.from_user.language_code),
        reply_markup=get_admin_menu_kb()
    )
    await state.set_state(AdminStates.menu)


@router.callback_query(StateFilter(AdminStates.menu), F.data == "admin_users")
async def callback_admin_users(call: CallbackQuery, state: FSMContext):
    await call.message.edit_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ TG ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°:")
    await state.set_state(AdminStates.user_input_id)


from app.services.user_stats import (
    get_root_referrer,
    get_referral_counts,
    get_active_referrals_count,
    get_total_deposits,
    get_total_withdrawals,
)

@router.message(StateFilter(AdminStates.user_input_id))
async def process_user_id(msg: Message, state: FSMContext):
    try:
        user_tg_id = int(msg.text.strip())
    except ValueError:
        await msg.answer("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ TG ID. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ¸Ñ„Ñ€Ñ‹.")
        return

    db = SessionLocal()
    user = db.query(User).filter(User.tg_id == user_tg_id).first()
    db.close()

    if not user:
        await msg.answer("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.", reply_markup=get_admin_menu_kb())
        await state.clear()
        return

    await show_user_card(msg, user_tg_id)
    await state.set_state(AdminStates.user_detail)



@router.callback_query(F.data.startswith("user_edit_ref:"))
async def edit_referrer_prompt(call: CallbackQuery, state: FSMContext):
    tg_id = int(call.data.split(":")[1])
    await state.update_data(editing_user_tg=tg_id)
    await call.message.edit_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ TG ID Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ĞµĞ»Ñ:")
    await state.set_state(AdminStates.editing_referrer)

@router.message(StateFilter(AdminStates.editing_referrer))
async def edit_referrer_save(msg: Message, state: FSMContext):
    db = SessionLocal()
    data = await state.get_data()
    target_tg_id = data.get("editing_user_tg")

    new_ref_tg = msg.text.strip()
    if not new_ref_tg.isdigit():
        await msg.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ TG ID Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.")
        return

    target_user = db.query(User).filter(User.tg_id == target_tg_id).first()
    new_ref = db.query(User).filter(User.tg_id == int(new_ref_tg)).first()

    if not target_user or not new_ref:
        db.close()
        await msg.answer("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        await state.clear()
        return

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ñ†Ğ¸ĞºĞ»
    current = new_ref
    while current:
        if current.id == target_user.id:
            db.close()
            await msg.answer("âŒ ĞĞµĞ»ÑŒĞ·Ñ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ¼ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ ÑĞµĞ±Ñ Ğ¸Ğ»Ğ¸ Ğ½Ğ¸Ğ¶Ğµ Ğ¿Ğ¾ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ.")
            await state.clear()
            return
        current = db.query(User).filter(User.id == current.referrer_id).first()

    target_user.referrer_id = new_ref.id
    db.commit()
    db.close()

    await msg.answer("âœ… ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ĞµĞ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½.")
    await state.clear()


@router.callback_query(F.data.startswith("user_edit_balance:"))
async def edit_balance_prompt(call: CallbackQuery, state: FSMContext):
    tg_id = int(call.data.split(":")[1])
    await state.update_data(editing_user_tg=tg_id)
    await call.message.edit_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ² USD:")
    await state.set_state(AdminStates.editing_balance)


@router.message(StateFilter(AdminStates.editing_balance))
async def edit_balance_save(msg: Message, state: FSMContext):
    db = SessionLocal()
    data = await state.get_data()
    target_tg_id = data.get("editing_user_tg")

    try:
        new_balance = float(msg.text.strip())
    except ValueError:
        await msg.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼.")
        return

    user = db.query(User).filter(User.tg_id == target_tg_id).first()
    if not user:
        db.close()
        await msg.answer("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        await state.clear()
        return

    user.profit_usd = round(new_balance, 2)
    db.commit()
    db.close()

    await msg.answer(f"âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: {new_balance:.2f} USD")
    await state.clear()


@router.callback_query(F.data.startswith("user_edit_pool:"))
async def edit_pool_prompt(call: CallbackQuery, state: FSMContext):
    tg_id = int(call.data.split(":")[1])
    await state.update_data(editing_user_tg=tg_id)

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="Basic", callback_data="set_pool:Basic")],
            [InlineKeyboardButton(text="Smart", callback_data="set_pool:Smart")],
            [InlineKeyboardButton(text="Pro", callback_data="set_pool:Pro")],
            [InlineKeyboardButton(text="ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")]
        ]
    )

    await call.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿ÑƒĞ», ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:", reply_markup=kb)
    await state.set_state(AdminStates.editing_pool)


from datetime import datetime
from app.models.investments import Investment

@router.callback_query(StateFilter(AdminStates.editing_pool), F.data.startswith("set_pool:"))
async def save_selected_pool(call: CallbackQuery, state: FSMContext):
    db = SessionLocal()
    data = await state.get_data()
    target_tg_id = data.get("editing_user_tg")
    pool_name = call.data.split(":")[1]

    user = db.query(User).filter(User.tg_id == target_tg_id).first()
    if not user:
        db.close()
        await call.message.answer("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        await state.clear()
        return

    exists = db.query(Investment).filter_by(user_id=user.id, pool_name=pool_name, is_active=True).first()
    if exists:
        db.close()
        await call.message.edit_text(f"â„¹ï¸ Ğ£ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ğ²ĞµÑÑ‚Ğ¸Ñ†Ğ¸Ñ Ğ² Ğ¿ÑƒĞ»Ğµ {pool_name}.")
        await state.clear()
        return

    investment = Investment(
        user_id=user.id,
        pool_name=pool_name,
        amount_usd=0.0,
        is_active=True,
        included_today=False,
        created_at=datetime.utcnow()
    )
    db.add(investment)
    db.commit()
    db.close()

    await call.message.edit_text(f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¿ÑƒĞ»: {pool_name}")
    await state.clear()



@router.callback_query(F.data.startswith("user_partners:"))
async def choose_ref_level(call: CallbackQuery, state: FSMContext):
    tg_id = int(call.data.split(":")[1])
    await state.update_data(editing_user_tg=tg_id)

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="1 ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ", callback_data="ref_level:1"),
                InlineKeyboardButton(text="2", callback_data="ref_level:2"),
                InlineKeyboardButton(text="3", callback_data="ref_level:3"),
            ],
            [
                InlineKeyboardButton(text="4", callback_data="ref_level:4"),
                InlineKeyboardButton(text="5", callback_data="ref_level:5"),
                InlineKeyboardButton(text="ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back"),
            ],
        ]
    )

    await call.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¿Ğ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ¾Ğ²:", reply_markup=kb)
    await state.set_state(AdminStates.choosing_ref_level)


@router.callback_query(StateFilter(AdminStates.choosing_ref_level), F.data.startswith("ref_level:"))
async def show_partners_by_level(call: CallbackQuery, state: FSMContext):
    db = SessionLocal()
    data = await state.get_data()
    target_user = db.query(User).filter(User.tg_id == data.get("editing_user_tg")).first()
    level = int(call.data.split(":")[1])

    users = []
    current_level = [target_user]
    for _ in range(level):
        next_level = []
        for u in current_level:
            children = db.query(User).filter(User.referrer_id == u.id).all()
            next_level.extend(children)
        current_level = next_level
    users = current_level

    active_users = [u for u in users if u.deposit_usd > 0]
    inactive_users = [u for u in users if u.deposit_usd == 0]

    def format_user(u):
        return f"@{u.username or 'â€”'} (`{u.tg_id}`) {'âœ…' if u.deposit_usd > 0 else 'âŒ'}"

    text = f"<b>ĞŸĞ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ñ‹ {level} ÑƒÑ€Ğ¾Ğ²Ğ½Ñ:</b>\n\n"
    for u in active_users + inactive_users:
        text += format_user(u) + "\n"

    if not users:
        text = f"âŒ ĞŸĞ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ğ¾Ğ² {level} ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾."

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"user_partners:{target_user.tg_id}")],
            [InlineKeyboardButton(text="Ğ’ Ğ¼ĞµĞ½Ñ", callback_data="admin_back")]
        ]
    )

    db.close()
    await call.message.edit_text(text, reply_markup=kb)



@router.callback_query(F.data.startswith("user_edit_menu:"))
async def show_user_edit_menu(call: CallbackQuery, state: FSMContext):
    tg_id = int(call.data.split(":")[1])
    await state.update_data(editing_user_tg=tg_id)

    user = SessionLocal().query(User).filter(User.tg_id == tg_id).first()

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ‘¤ Ğ˜Ğ·Ğ¼. Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ĞµĞ»Ñ", callback_data=f"user_edit_ref:{tg_id}")],
            [InlineKeyboardButton(text="ğŸ’° Ğ˜Ğ·Ğ¼. Ğ±Ğ°Ğ»Ğ°Ğ½Ñ", callback_data=f"user_edit_balance:{tg_id}")],
            [InlineKeyboardButton(text="ğŸ¦ Ğ˜Ğ·Ğ¼. Ğ¿ÑƒĞ»", callback_data=f"user_edit_pool:{tg_id}")],
            [
                InlineKeyboardButton(
                    text="ğŸ”“ ĞĞ½Ğ±Ğ°Ğ½" if getattr(user, "is_banned", False) else "â›” Ğ‘Ğ°Ğ½",
                    callback_data=f"user_{'unban' if getattr(user, 'is_banned', False) else 'ban'}:{tg_id}"
                )
            ],
            [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"user_back:{tg_id}")]
        ]
    )

    await call.message.edit_text("ğŸ”§ Ğ§Ñ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ?", reply_markup=kb)



@router.callback_query(StateFilter(AdminStates.user_detail), F.data == "admin_back")
async def callback_admin_back(call: CallbackQuery, state: FSMContext):
    await call.message.edit_text(
        t("admin_panel", call.from_user.language_code),
        reply_markup=get_admin_menu_kb()
    )
    await state.set_state(AdminStates.menu)


async def show_user_card(message: Message | CallbackQuery, user_tg_id: int):
    db = SessionLocal()
    user = db.query(User).filter(User.tg_id == user_tg_id).first()
    if not user:
        db.close()
        await message.answer("âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")
        return

    investments = db.query(Investment).filter(Investment.user_id == user.id, Investment.is_active == True).all()
    pools = {}
    for inv in investments:
        pools.setdefault(inv.pool_name, 0.0)
        pools[inv.pool_name] += inv.amount_usd

    total_deposit = get_total_deposits(db, user.id)
    total_withdraw = get_total_withdrawals(db, user.id)
    ref_counts = get_referral_counts(db, user)
    active_refs = get_active_referrals_count(db, user)
    referrer = db.query(User).filter(User.id == user.referrer_id).first()
    root_ref = get_root_referrer(db, user)
    db.close()

    pool_lines = "\n".join(f"ğŸ’¼ {name}: {amount:.2f} USD" for name, amount in pools.items() if amount > 0)
    ref_line = " ".join([f"{i}:{count}" for i, count in ref_counts.items()])

    text = (
        f"ğŸ‘¤ @{user.username or 'â€”'} (`{user.tg_id}`)\n\n"
        f"ğŸ’° <b>Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ:</b> {user.profit_usd:.2f} USD\n"
        + (f"{pool_lines}\n" if pool_lines else "") +
        f"ğŸ”¼ <b>ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾:</b> {total_deposit:.2f} USD\n"
        f"ğŸ”½ <b>Ğ’Ñ‹Ğ²ĞµĞ´ĞµĞ½Ğ¾:</b> {total_withdraw:.2f} USD\n\n"
        f"ğŸ‘¥ <b>ĞŸĞ°Ñ€Ñ‚Ğ½Ñ‘Ñ€Ñ‹:</b> {ref_line}\n"
        f"âœ… <b>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…:</b> {active_refs}\n\n"
        + (
            f"ğŸ“¥ <b>ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ĞµĞ»ÑŒ:</b> @{referrer.username or 'â€”'} (`{referrer.tg_id}`)\n"
            if referrer else ""
        )
        + f"ğŸŒ³ <b>Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ² ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ:</b> @{root_ref.username or 'â€”'} (`{root_ref.tg_id}`)\n"
        f"ğŸŒ <b>Ğ¯Ğ·Ñ‹Ğº:</b> {user.lang.upper()}"
    )

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ”§ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ", callback_data=f"user_edit_menu:{user.tg_id}")],
            [
                InlineKeyboardButton(text="ğŸ‘¥ ĞŸĞ°Ñ€Ñ‚Ğ½ĞµÑ€Ñ‹", callback_data=f"user_partners:{user.tg_id}"),
                InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="admin_back")
            ]
        ]
    )

    if isinstance(message, CallbackQuery):
        await message.message.edit_text(text, reply_markup=kb)
    else:
        await message.answer(text, reply_markup=kb)

@router.callback_query(F.data.startswith("user_back:"))
async def return_to_user_card(call: CallbackQuery, state: FSMContext):
    user_tg_id = int(call.data.split(":")[1])
    await show_user_card(call, user_tg_id)
    await state.set_state(AdminStates.user_detail)